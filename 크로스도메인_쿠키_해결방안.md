# 크로스도메인 쿠키 문제 해결 방안

## 🚨 현재 상황
- `jangmadang.site` (메인 도메인)
- `jmd-fe.vercel.app` (완전히 다른 도메인 - Vercel)
- **서브도메인이 아닌 크로스도메인 환경**

## 🔧 해결 방안

### 방안 1: 백엔드에서 쿠키 도메인을 null로 설정

**UserController.java에서 쿠키 설정:**
```java
// 로그인 시 쿠키 설정
Cookie sessionCookie = new Cookie("JSESSIONID", sessionId);
// sessionCookie.setDomain(".jangmadang.site"); // ❌ 제거
sessionCookie.setPath("/");
sessionCookie.setHttpOnly(true);
sessionCookie.setSecure(true);
sessionCookie.setMaxAge(24 * 60 * 60); // 24시간
response.addCookie(sessionCookie);

// JWT 토큰 쿠키도 동일하게
Cookie accessCookie = new Cookie("access", accessToken);
// accessCookie.setDomain(".jangmadang.site"); // ❌ 제거
accessCookie.setPath("/");
accessCookie.setHttpOnly(true);
accessCookie.setSecure(true);
accessCookie.setMaxAge(60 * 60); // 1시간
response.addCookie(accessCookie);
```

### 방안 2: application.properties 설정

```properties
# 세션 쿠키 설정 (도메인 제거)
server.servlet.session.cookie.path=/
server.servlet.session.cookie.http-only=true
server.servlet.session.cookie.secure=true
server.servlet.session.cookie.same-site=none
# server.servlet.session.cookie.domain=.jangmadang.site  # ❌ 주석 처리
```

### 방안 3: CORS 설정 강화

**WebConfig.java:**
```java
@Configuration
public class WebConfig implements WebMvcConfigurer {
    
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/**")
            .allowedOriginPatterns("*") // 모든 도메인 허용 (개발용)
            // 또는 특정 도메인만 허용
            // .allowedOrigins(
            //     "https://jangmadang.site",
            //     "https://www.jangmadang.site", 
            //     "https://jmd-fe.vercel.app"
            // )
            .allowedMethods("GET", "POST", "PUT", "DELETE", "OPTIONS")
            .allowedHeaders("*")
            .allowCredentials(true)
            .maxAge(3600);
    }
}
```

### 방안 4: 로그아웃 시 쿠키 삭제 (크로스도메인용)

```java
@PostMapping("/api/permit/logout")
public ResponseEntity<?> logout(HttpServletRequest request, HttpServletResponse response) {
    try {
        // 1. 세션 무효화
        HttpSession session = request.getSession(false);
        if (session != null) {
            session.invalidate();
        }
        
        // 2. 모든 관련 쿠키 삭제 (도메인 없이)
        String[] cookieNames = {"JSESSIONID", "access", "refresh", "idtoken"};
        
        for (String cookieName : cookieNames) {
            // 도메인 없이 삭제 (크로스도메인에서 작동)
            Cookie cookie = new Cookie(cookieName, null);
            // cookie.setDomain(".jangmadang.site"); // ❌ 제거
            cookie.setPath("/");
            cookie.setMaxAge(0);
            cookie.setHttpOnly(true);
            cookie.setSecure(true);
            response.addCookie(cookie);
        }
        
        return ResponseEntity.ok(Map.of(
            "isSuccess", true,
            "code", "USER_2004", 
            "message", "성공적으로 로그아웃하였습니다."
        ));
        
    } catch (Exception e) {
        return ResponseEntity.status(500).body(Map.of(
            "isSuccess", false,
            "message", "로그아웃 처리 중 오류가 발생했습니다."
        ));
    }
}
```

## 🧪 테스트 방법

1. **백엔드에서 쿠키 도메인 설정 제거**
2. **브라우저 쿠키 완전 삭제**
3. **https://jmd-fe.vercel.app에서 로그인 테스트**
4. **네트워크 탭에서 Set-Cookie 헤더 확인**

## 📋 확인 사항

- [ ] 쿠키 도메인 설정이 제거됨 (null)
- [ ] CORS 설정에 `jmd-fe.vercel.app` 포함됨
- [ ] `allowCredentials: true` 설정됨
- [ ] `sameSite: 'none'` 설정됨

## 🎯 예상 결과

수정 후:
- `jmd-fe.vercel.app`에서도 쿠키가 정상적으로 설정됨
- 로그인/로그아웃이 모든 도메인에서 정상 작동
- 세션이 null로 전달되지 않음

## ⚠️ 주의사항

- **SameSite=None**은 **Secure=true**와 함께 사용해야 함
- **HTTPS 환경에서만 작동**함
- **브라우저 보안 정책**에 따라 일부 제한이 있을 수 있음 