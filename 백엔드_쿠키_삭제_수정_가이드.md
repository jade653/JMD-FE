# 백엔드 쿠키 삭제 수정 가이드

## 🚨 현재 문제
- 로그아웃 API는 성공 (200 응답)
- 하지만 쿠키가 삭제되지 않음 (`cookiesAfterResponse: ''`)
- 로그아웃 후 바로 다시 로그인됨

## 🔧 해결 방법

### 1. 로그아웃 API 수정 (UserController.java)

**현재 문제가 있는 코드:**
```java
@PostMapping("/api/permit/logout")
public ResponseEntity<?> logout(HttpServletRequest request, HttpServletResponse response) {
    // 세션만 무효화하고 쿠키는 삭제하지 않음
    HttpSession session = request.getSession(false);
    if (session != null) {
        session.invalidate();
    }
    
    return ResponseEntity.ok(Map.of(
        "isSuccess", true,
        "code", "USER_2004", 
        "message", "성공적으로 로그아웃하였습니다."
    ));
}
```

**수정된 코드:**
```java
@PostMapping("/api/permit/logout")
public ResponseEntity<?> logout(HttpServletRequest request, HttpServletResponse response) {
    try {
        // 1. 세션 무효화
        HttpSession session = request.getSession(false);
        if (session != null) {
            session.invalidate();
        }
        
        // 2. 모든 관련 쿠키 삭제 (크로스도메인용)
        String[] cookieNames = {"JSESSIONID", "access", "refresh", "idtoken"};
        
        for (String cookieName : cookieNames) {
            // 방법 1: 도메인 없이 삭제 (크로스도메인에서 작동)
            Cookie cookie = new Cookie(cookieName, null);
            cookie.setPath("/");
            cookie.setMaxAge(0);
            cookie.setHttpOnly(true);
            cookie.setSecure(true);
            response.addCookie(cookie);
            
            // 방법 2: 여러 도메인에서 삭제 시도
            Cookie domainCookie = new Cookie(cookieName, null);
            domainCookie.setDomain(".jangmadang.site");
            domainCookie.setPath("/");
            domainCookie.setMaxAge(0);
            domainCookie.setHttpOnly(true);
            domainCookie.setSecure(true);
            response.addCookie(domainCookie);
            
            // 방법 3: 현재 도메인에서도 삭제
            Cookie currentCookie = new Cookie(cookieName, null);
            currentCookie.setPath("/");
            currentCookie.setMaxAge(0);
            currentCookie.setHttpOnly(true);
            currentCookie.setSecure(true);
            response.addCookie(currentCookie);
        }
        
        // 3. 응답 헤더에 쿠키 삭제 명시
        response.setHeader("Set-Cookie", 
            "JSESSIONID=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT; HttpOnly; Secure; SameSite=None, " +
            "access=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT; HttpOnly; Secure; SameSite=None, " +
            "refresh=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT; HttpOnly; Secure; SameSite=None, " +
            "idtoken=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT; HttpOnly; Secure; SameSite=None"
        );
        
        return ResponseEntity.ok(Map.of(
            "isSuccess", true,
            "code", "USER_2004", 
            "message", "성공적으로 로그아웃하였습니다."
        ));
        
    } catch (Exception e) {
        return ResponseEntity.status(500).body(Map.of(
            "isSuccess", false,
            "message", "로그아웃 처리 중 오류가 발생했습니다."
        ));
    }
}
```

### 2. Spring Boot 세션 설정 확인

**application.properties:**
```properties
# 세션 쿠키 설정
server.servlet.session.cookie.path=/
server.servlet.session.cookie.http-only=true
server.servlet.session.cookie.secure=true
server.servlet.session.cookie.same-site=none
# server.servlet.session.cookie.domain=.jangmadang.site  # 크로스도메인에서는 제거
```

### 3. CORS 설정 확인

**WebConfig.java:**
```java
@Configuration
public class WebConfig implements WebMvcConfigurer {
    
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/**")
            .allowedOrigins(
                "https://jangmadang.site",
                "https://www.jangmadang.site", 
                "https://jmd-fe.vercel.app"
            )
            .allowedMethods("GET", "POST", "PUT", "DELETE", "OPTIONS")
            .allowedHeaders("*")
            .allowCredentials(true)
            .exposedHeaders("Set-Cookie") // 쿠키 헤더 노출
            .maxAge(3600);
    }
}
```

## 🧪 테스트 방법

1. **백엔드 수정 후 재배포**
2. **브라우저에서 쿠키 완전 삭제**
3. **https://jmd-fe.vercel.app에서 로그인**
4. **로그아웃 버튼 클릭**
5. **네트워크 탭에서 Set-Cookie 헤더 확인**
6. **로그아웃 후 다시 로그인 시도**

## 📋 확인 사항

- [ ] 로그아웃 API에서 모든 쿠키를 삭제하는 코드 추가
- [ ] Set-Cookie 헤더에 쿠키 삭제 명시
- [ ] CORS 설정에 `exposedHeaders: "Set-Cookie"` 추가
- [ ] 여러 도메인에서 쿠키 삭제 시도

## 🎯 예상 결과

수정 후:
- 로그아웃 시 모든 쿠키가 제대로 삭제됨
- `cookiesAfterResponse: ''` 대신 실제 쿠키 삭제 확인 가능
- 로그아웃 후 다시 로그인되지 않음 