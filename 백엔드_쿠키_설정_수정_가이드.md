# 백엔드 쿠키 설정 수정 가이드

## 🚨 현재 문제
- `jangmadang.site`에서는 로그인/로그아웃이 정상 작동
- `jmd-fe.vercel.app`에서는 쿠키가 전송되지 않아 세션이 null로 전달됨

## 🔧 해결 방법

### 1. 쿠키 도메인 설정 수정

**현재 설정 (문제):**
```java
// 현재: api.jangmadang.site 도메인으로만 설정
Cookie cookie = new Cookie("JSESSIONID", sessionId);
cookie.setDomain("api.jangmadang.site"); // ❌ 문제
```

**수정된 설정:**
```java
// 수정: 공통 도메인으로 설정하여 모든 서브도메인에서 접근 가능
Cookie cookie = new Cookie("JSESSIONID", sessionId);
cookie.setDomain(".jangmadang.site"); // ✅ 해결 (점으로 시작)
```

### 2. Spring Boot 세션 설정

**application.properties 또는 application.yml:**
```properties
# 세션 쿠키 설정
server.servlet.session.cookie.domain=.jangmadang.site
server.servlet.session.cookie.path=/
server.servlet.session.cookie.http-only=true
server.servlet.session.cookie.secure=true
server.servlet.session.cookie.same-site=none
```

### 3. CORS 설정 확인

**WebConfig.java 또는 SecurityConfig.java:**
```java
@Configuration
public class WebConfig implements WebMvcConfigurer {
    
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/**")
            .allowedOrigins(
                "https://jangmadang.site",
                "https://www.jangmadang.site", 
                "https://jmd-fe.vercel.app",
                "https://api.jangmadang.site"
            )
            .allowedMethods("GET", "POST", "PUT", "DELETE", "OPTIONS")
            .allowedHeaders("*")
            .allowCredentials(true)
            .maxAge(3600);
    }
}
```

### 4. 로그아웃 시 쿠키 삭제

**UserController.java의 logout 메서드:**
```java
@PostMapping("/api/permit/logout")
public ResponseEntity<?> logout(HttpServletRequest request, HttpServletResponse response) {
    try {
        // 1. 세션 무효화
        HttpSession session = request.getSession(false);
        if (session != null) {
            session.invalidate();
        }
        
        // 2. 모든 관련 쿠키 삭제 (여러 도메인에서)
        String[] cookieNames = {"JSESSIONID", "access", "refresh", "idtoken"};
        
        for (String cookieName : cookieNames) {
            // .jangmadang.site 도메인에서 삭제
            Cookie cookie = new Cookie(cookieName, null);
            cookie.setDomain(".jangmadang.site");
            cookie.setPath("/");
            cookie.setMaxAge(0);
            cookie.setHttpOnly(true);
            cookie.setSecure(true);
            response.addCookie(cookie);
            
            // 추가로 현재 도메인에서도 삭제
            Cookie localCookie = new Cookie(cookieName, null);
            localCookie.setPath("/");
            localCookie.setMaxAge(0);
            localCookie.setHttpOnly(true);
            localCookie.setSecure(true);
            response.addCookie(localCookie);
        }
        
        return ResponseEntity.ok(Map.of(
            "isSuccess", true,
            "code", "USER_2004", 
            "message", "성공적으로 로그아웃하였습니다."
        ));
        
    } catch (Exception e) {
        return ResponseEntity.status(500).body(Map.of(
            "isSuccess", false,
            "message", "로그아웃 처리 중 오류가 발생했습니다."
        ));
    }
}
```

## 🧪 테스트 방법

1. **백엔드 수정 후 재배포**
2. **브라우저에서 쿠키 완전 삭제**
3. **https://jmd-fe.vercel.app에서 로그인 테스트**
4. **네트워크 탭에서 쿠키 전송 확인**

## 📋 확인 사항

- [ ] 쿠키 도메인이 `.jangmadang.site`로 설정됨
- [ ] CORS 설정에 `jmd-fe.vercel.app` 포함됨
- [ ] `allowCredentials: true` 설정됨
- [ ] 로그아웃 시 모든 도메인에서 쿠키 삭제됨

## 🎯 예상 결과

수정 후:
- `jmd-fe.vercel.app`에서도 쿠키가 정상적으로 전송됨
- 로그인/로그아웃이 모든 도메인에서 정상 작동
- 세션이 null로 전달되지 않음 